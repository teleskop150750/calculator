name: Build Windows Portable

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  windows-portable:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Temurin 21 (with Maven cache)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Download JavaFX jmods (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $jfxVersion = "21.0.5"
          $zipPath = Join-Path $env:RUNNER_TEMP "javafx-jmods.zip"
          # Use Oracle/Gluon mirror that works from GitHub Actions
          Invoke-WebRequest -Uri "https://download2.gluonhq.com/openjfx/$jfxVersion/openjfx-${jfxVersion}_windows-x64_bin-jmods.zip" -OutFile $zipPath -UseBasicParsing
          if (-not (Test-Path $zipPath)) {
            # Fallback to alternative mirror
            Invoke-WebRequest -Uri "https://gluonhq.com/download/javafx-${jfxVersion}-jmods-windows" -OutFile $zipPath -UseBasicParsing
          }
          Expand-Archive -Path $zipPath -DestinationPath (Join-Path $env:RUNNER_TEMP "javafx-jmods") -Force
          $jmods = Join-Path (Join-Path $env:RUNNER_TEMP "javafx-jmods") "javafx-jmods-$jfxVersion"
          "JFX_JMODS=$jmods" >> $env:GITHUB_ENV

      - name: Build jar
        run: mvn -B -DskipTests package

      - name: Create portable app-image (jpackage)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $dest = "target/win-portable"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          $modulePath = "$env:JFX_JMODS;target/demo-1.0-SNAPSHOT.jar;$env:JAVA_HOME\jmods"
          jpackage `
            --type app-image `
            --dest $dest `
            --name FXCalc `
            --app-version "1.0.0" `
            --module-path $modulePath `
            --module com.example/com.example.App `
            --java-options "--enable-native-access=javafx.graphics" `
            --jlink-options "--strip-debug --no-header-files --no-man-pages --compress zip-6"

      - name: Zip portable bundle
        shell: pwsh
        run: |
          $src = "target/win-portable/FXCalc"
          $zip = "target/fxcalc-windows-portable.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$src\*" -DestinationPath $zip

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: fxcalc-windows-portable
          path: target/fxcalc-windows-portable.zip